// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// CHAT-TO-CREATE MODELS
// ============================================

model Conversation {
  id        String   @id @default(uuid())
  userId    String
  projectId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  messages  Message[]

  @@index([userId])
  @@index([projectId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  role           String       // user | assistant | system
  content        String       // Text content
  intent         String?      // GENERATE_BEAT, MIX_TRACK, etc.
  entities       String?      // JSON string: { genre, bpm, key, mood }
  generationId   String?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([generationId])
}

model Generation {
  id          String    @id @default(uuid())
  userId      String
  projectId   String?
  type        String    // beat | stems | mix | master
  status      String    // pending | processing | completed | failed
  input       String    // JSON string: User request parameters
  output      String?   // JSON string: Generated audio URLs, metadata
  provider    String
  cost        Float     @default(0)
  duration    Int?
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([status])
}

// ============================================
// USER AUTHENTICATION & PROFILES
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String?   // Nullable for OAuth-only users
  name          String?
  profileImage  String?

  // OAuth providers
  googleId      String?   @unique
  googleEmail   String?

  // Account status
  emailVerified Boolean   @default(false)
  isActive      Boolean   @default(true)

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  sessions      Session[]
  aiMemories    AIMemory[]
  projects      Project[]

  @@index([email])
  @@index([googleId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ============================================
// AI PERSISTENT MEMORY SYSTEM
// ============================================

model AIMemory {
  id           String   @id @default(uuid())
  userId       String

  // Memory content
  type         String   // preference | fact | context | interaction
  category     String?  // music_production | mixing | workflow | personal
  content      String   // The actual memory content
  metadata     String?  // JSON: { confidence, source, tags, etc. }

  // Memory importance and retrieval
  importance   Int      @default(5) // 1-10 scale
  accessCount  Int      @default(0)
  lastAccessed DateTime @default(now())

  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  expiresAt    DateTime? // Optional expiration for temporary memories

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([importance])
  @@index([lastAccessed])
}

// ============================================
// PROJECTS & RECORDINGS
// ============================================

model Project {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String?

  // Project settings
  tempo       Int      @default(120)
  key         String   @default("C")
  timeSignature String @default("4/4")

  // Project data
  tracks      String   // JSON: Track configuration
  metadata    String?  // JSON: Additional project metadata

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// COST MONITORING SYSTEM
// ============================================

model ApiUsageLog {
  id          String   @id @default(uuid())
  userId      String

  // API details
  service     String   // whisper | gpt-4o | tts-1-hd | realtime-api
  operation   String   // transcription | chat | synthesis | realtime-chat | realtime-audio-input | realtime-audio-output

  // Usage metrics
  inputTokens  Int?     // For GPT-4o and Realtime API
  outputTokens Int?     // For GPT-4o and Realtime API
  audioMinutes Float?   // For Whisper and Realtime audio
  characters   Int?     // For TTS

  // Cost calculation
  unitCost     Float    // Cost per unit (per token, minute, character)
  totalCost    Float    // Total cost for this usage

  // Metadata
  requestId    String?  // Unique request identifier
  metadata     String?  // JSON: Additional context

  // Timestamps
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([service])
  @@index([createdAt])
}

model BudgetLimit {
  id          String   @id @default(uuid())
  userId      String   @unique

  // Budget settings
  dailyLimit   Float?   // Daily budget limit in USD
  monthlyLimit Float?   // Monthly budget limit in USD

  // Current usage (reset periodically)
  dailySpent   Float    @default(0)
  monthlySpent Float    @default(0)

  // Alert settings
  alertThreshold Float  @default(0.8) // Alert at 80% of budget
  alertsEnabled  Boolean @default(true)
  pauseOnExceed  Boolean @default(false) // Pause services when budget exceeded

  // Last reset timestamps
  lastDailyReset   DateTime @default(now())
  lastMonthlyReset DateTime @default(now())

  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model CostAlert {
  id          String   @id @default(uuid())
  userId      String

  // Alert details
  type        String   // threshold_reached | budget_exceeded | daily_summary
  message     String
  severity    String   // info | warning | critical

  // Alert data
  currentSpent Float
  budgetLimit  Float?
  percentage   Float?   // Percentage of budget used

  // Status
  isRead      Boolean  @default(false)
  isResolved  Boolean  @default(false)

  // Timestamps
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// AI TRAINING DATA COLLECTION
// ============================================

model TrainingMetadata {
  id                String    @id @default(uuid())
  userId            String
  generationId      String    @unique

  // User input
  userPrompt        String
  aiEnhancedPrompt  String?

  // Generation parameters (JSON)
  generationParams  String    // { genre, bpm, key, mood, style, duration, model, provider }

  // Generated output
  audioUrl          String
  audioStorageKey   String?   // S3/storage key if we store it
  duration          Float
  format            String

  // Analysis results (JSON)
  analysisMetadata  String?   // VocalCharacteristics, RhythmCharacteristics, StyleMetadata

  // Audio features (JSON)
  audioEmbedding    String?   // Feature vector for similarity search
  spectralFeatures  String?   // spectralCentroid, spectralRolloff, mfcc, chromagram

  // User feedback (JSON)
  userFeedback      String?   // { liked, rating, feedback, used, feedbackTimestamp }

  // Training metadata
  provider          String    // suno, musicgen, expert_music_ai
  modelUsed         String?
  generationCost    Float?
  generationDuration Float?   // Time to generate in seconds

  // Training flags
  usedForTraining   Boolean   @default(false)
  trainingEpoch     Int?      // Which training epoch used this data
  qualityScore      Float?    // Auto-computed quality score (0-1)

  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@index([provider])
  @@index([usedForTraining])
  @@index([createdAt])
}

// ============================================
// EXISTING MODELS (if any)
// Add your existing models below
// ============================================
